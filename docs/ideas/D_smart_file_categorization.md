# Idea D: Smart File Role Categorization

## Origin
chuckjewell fork -- grep --source-only with static exclude lists.
The idea is to replace static lists with SMART auto-detection of file roles.

## Why
Current --source-only uses hardcoded excludes (*.md, *.json, etc.).
Current --test-only uses flat lists duplicated between cmd_testmap.py and changed_files.py.
A smart classifier would auto-detect roles without maintaining brittle lists.

## Research Findings

GitHub Linguist + go-enry use tiered heuristic strategies (path -> filename -> content).
Achieves ~95% accuracy. ML adds complexity for marginal improvement.

### File Role Taxonomy

**Core roles:** source, test, config, build, docs, generated, vendored
**Secondary:** data, examples, dotfile, media, scripts, ci

### Three-Tier Heuristic Strategy

**Tier 1 -- Path-based (no I/O, ~90% coverage)**
- Directory patterns: tests/, vendor/, docs/, examples/, scripts/, .github/
- Compiled regex, microseconds per file

**Tier 2 -- Filename + extension (no I/O)**
- Exact matches: Makefile, Dockerfile, Jenkinsfile, README, LICENSE
- Extension-based language type: .json/.yaml -> data, .md -> docs
- Combined: .py in tests/ -> test

**Tier 3 -- Content-based (selective I/O)**
- First 10-50 lines for "DO NOT EDIT", "generated by" markers
- Shebang detection for scripts
- Minification (avg line > 110 chars for .js/.css)

### Priority / Conflict Resolution
1. Explicit overrides (.roamattributes)
2. Generated (content-detected)
3. Vendored (path-detected)
4. Test (name/path patterns)
5. Build / CI (exact filename)
6. Docs, Config, Examples
7. Source (default)

### Implementation

**Schema change:**
```sql
ALTER TABLE files ADD COLUMN file_role TEXT;  -- computed during indexing
```

**API functions (like go-enry):**
```python
def classify_file(path, content=None) -> str
def is_test(path) -> bool
def is_source(path) -> bool
def is_generated(path, content=None) -> bool
def is_vendored(path) -> bool
```

**CLI integration:**
```bash
roam grep "pattern" --role source       # replaces --source-only
roam grep "pattern" --role test         # replaces --test-only
roam grep "pattern" --exclude-role docs,generated,vendored
```

### Test Pattern Improvements (fixes real gaps)
Current `_is_test_file()` misses: `*Test.java`, `*Tests.java`, `*Test.kt`,
`*Test.cs`, `*Test.php`, `*Tests.swift`, `IT*.java`, `*_test.go`,
`src/test/java/` directories, `src/androidTest/`.

### Key: Start with Tier 1 Only
Path patterns cover 90% of cases with zero I/O cost.
Add content-based in a follow-up iteration.

## Priority: HIGH (Tier 1)
## Effort: Medium
## Files touched: New index/file_roles.py, schema.py, cmd_grep.py, cmd_testmap.py, changed_files.py
